---
title: "Geography and Built Form - Metro Deep Dive"
output: html_notebook
---

# Set up the environment
```{r Load Utils}
# This will load common Libraries and Functions

source(here::here("scripts", "utils.R"))
```


```{r Load Libraries}
library(sf)
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(purrr)
library(ggplot2)
library(units)
library(classInt)
library(osmdata)
```

```{r Set Parameters and Paths}
# Set paths for our environments
# Make sure we're reading from the project Renviron
if (file.exists(".Renviron")) readRenviron(".Renviron")

# Set paths
gold_xwalk_path <- get_env_path("GOLD_XWALK")
acs_tract_path <- get_env_path("SILVER_TRACT")

# Set Params
target_geoid <- "48900"
metro_name <- "Wilmington, NC"
cbsa_year_geo <- as.integer(2023)
base_year_geo <- cbsa_year_geo

crs_equal_area <- 5070 # NAD83 / Conus Albers (good for area/length)
crs_longlat <- 4326

```

```{r Custom Functions}
# ---- CBSA Load Functions ----
get_cbsa_geom <- function(cbsa_id, year = 2023) {
  tigris::core_based_statistical_areas(year = year, class = "sf") %>%
    clean_names() %>%
    transmute(cbsa_geoid = cbsafp, cbsa_name = name, geometry) %>%
    filter(cbsa_geoid == !!cbsa_id)
}

get_cbsa_states <- function(cbsa_id, crosswalk, year = 2023) {
  crosswalk %>%
    filter(cbsa_code == cbsa_id, year == !!year) %>%
    transmute(state = substr(county_geoid, 1, 2)) %>%
    distinct(state) %>%
    pull(state)
}

load_cbsa_tracts <- function(cbsa_id, crosswalk, year = 2023) {
  st_codes <- get_cbsa_states(cbsa_id, crosswalk, year)
  cbsa_g <- get_cbsa_geom(cbsa_id, year) %>% st_transform(crs_equal_area)
  trs <- purrr::map(st_codes, ~ tigris::tracts(state = .x, year = year, class = "sf", cb = TRUE)) %>%
    list_rbind() %>% clean_names() %>% st_transform(crs_equal_area)
  st_join(trs, cbsa_g, join = st_intersects, left = FALSE)
}

load_places <- function(cbsa_id, crosswalk, year = 2023) {
  st_codes <- get_cbsa_states(cbsa_id, crosswalk, year)
  pl <- purrr::map(st_codes, ~ tigris::places(state = .x, year = year, class = "sf")) %>%
    list_rbind() %>% clean_names()
  cbsa_g <- get_cbsa_geom(cbsa_id, year)
  st_intersection(st_transform(pl, st_crs(cbsa_g)), cbsa_g) %>% st_transform(crs_equal_area)
}

# Calculate Measurements ----
# 3.1 Safe area (km^2) and length (km) after projecting
project_and_measure <- function(g, epsg = crs_equal_area) {
  g %>% st_transform(epsg)
}

geom_area_km2 <- function(g_proj) {
  set_units(st_area(g_proj), km^2) %>% drop_units()
}

geom_length_km <- function(g_proj) {
  set_units(st_length(g_proj), km) %>% drop_units()
}

# Grid maker (for block-density style summaries) ----
make_hex_grid <- function(boundary, cell_km = 1) {
  b_proj <- project_and_measure(boundary)
  cell_size <- cell_km * 1000
  grid <- st_make_grid(b_proj, what = "polygons", square = FALSE, cellsize = cell_size)
  st_as_sf(grid) %>%
    st_intersection(b_proj) %>%
    mutate(hex_id = dplyr::row_number())
}

# Summarize roads/buildings by zone ----
sum_length_by_zone <- function(lines_proj, zones_proj, id_col = "zone_id") {
  inter <- st_intersection(lines_proj, zones_proj)
  inter %>% mutate(len_km = geom_length_km(inter)) %>% st_drop_geometry() %>%
    group_by(.data[[id_col]]) %>% summarize(road_km = sum(len_km, na.rm = TRUE), .groups = "drop")
}

sum_area_by_zone <- function(polys_proj, zones_proj, id_col = "zone_id") {
  inter <- st_intersection(polys_proj, zones_proj)
  inter %>% mutate(area_km2 = geom_area_km2(inter)) %>% st_drop_geometry() %>%
    group_by(.data[[id_col]]) %>% summarize(builtup_km2 = sum(area_km2, na.rm = TRUE), .groups = "drop")
}

# Class breaks for thematic mapping ----
make_breaks <- function(x, k = 5, style = "quantile") {
  classInt::classIntervals(x, n = k, style = style)$brks
}

```


```{r Load & Clean Data}
# CBSA <> County Crosswalk
cbsa_county_crosswalk <- readr::read_csv(paste0(gold_xwalk_path, "/cbsa_county_crosswalk.csv"), show_col_types = FALSE) %>%
  clean_names() %>%
  mutate(cbsa_code = as.character(cbsa_code))

# Silver Tract ACS Data
acs_tracts_nc <- readr::read_csv(paste0(acs_tract_path, "/acs_tract_nc_5_year.csv"), show_col_types = FALSE) %>%
  clean_names()

acs_clean_tracts_nc <- acs_tracts_nc %>% 
  select(geoid, year, pop_total = pop_total_e, median_income = income_med_e, median_rent = gross_rent_med_e, housing_units = total_housing_units_e, labor_force = in_labor_force_pop_e, rent_income_ratio = rent_income_percent) %>%
  mutate(geoid = as.character(geoid))

```

```{r Ingest Geo Data}
# GEO Shapes
  # CBSA
cbsa_g <- get_cbsa_geom(target_geoid, cbsa_year_geo) %>% st_transform(crs_equal_area)
  # Tracts
tr_cbsa <- load_cbsa_tracts(target_geoid, cbsa_county_crosswalk, cbsa_year_geo) %>% st_transform(crs_equal_area) 
  # Places
place_cbsa <- load_places(target_geoid, cbsa_county_crosswalk, cbsa_year_geo) %>% st_transform(crs_equal_area)
```


```{r Prepare Data}
# Join ACS Metrics to our Shapefiles and Compute Metrics
tr_df <- tr_cbsa %>%
  mutate(aland_km2 = aland / 1e6) %>%
  left_join(acs_clean_tracts_nc %>% filter(year == cbsa_year_geo), by = "geoid") %>%
  mutate(
    density        = if_else(aland_km2 > 0, pop_total / aland_km2, NA_real_)
  )

```

